[2024/08/06 17:54:18] 
[2024/08/06 17:54:18] > rm(list = ls())
[2024/08/06 17:54:18] 
[2024/08/06 17:54:18] > pacman::p_load(rvest, here, httr, openxlsx, zipangu, 
[2024/08/06 17:54:18] +     tidyverse, tidylog)
[2024/08/06 17:54:18] 
[2024/08/06 17:54:18] > today_ymd <- str_replace_all(Sys.Date(), "-", "") %>% 
[2024/08/06 17:54:18] +     print()
[2024/08/06 17:54:18] [1] "20240806"
[2024/08/06 17:54:18] 
[2024/08/06 17:54:18] > output_dir <- here(str_glue("output/{today_ymd}")) %>% 
[2024/08/06 17:54:18] +     print()
[2024/08/06 17:54:18] [1] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806"
[2024/08/06 17:54:18] 
[2024/08/06 17:54:18] > original_dir <- here(str_glue("{output_dir}/original")) %>% 
[2024/08/06 17:54:18] +     print()
[2024/08/06 17:54:18] [1] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original"
[2024/08/06 17:54:18] 
[2024/08/06 17:54:18] > if (dir.exists(output_dir)) {
[2024/08/06 17:54:18] +     unlink(output_dir, recursive = TRUE)
[2024/08/06 17:54:18] + }
[2024/08/06 17:54:18] 
[2024/08/06 17:54:18] > if (!dir.exists(original_dir)) {
[2024/08/06 17:54:18] +     dir.create(original_dir, recursive = TRUE)
[2024/08/06 17:54:18] + }
[2024/08/06 17:54:18] 
[2024/08/06 17:54:18] > df_kouseikyoku <- mutate(dplyr::tibble(district = c("東北", 
[2024/08/06 17:54:18] +     "関東信越", "四国", "近畿", "中国"), url = c("https://kouseikyoku.mhlw.go.jp/tohoku/gyomu/gyo ..." ... [TRUNCATED] 
[2024/08/06 17:54:18] mutate: new variable 'a_con' (character) with 4 unique values and 0% NA
[2024/08/06 17:54:18] Rows: 5
[2024/08/06 17:54:18] Columns: 4
[2024/08/06 17:54:18] $ district    <chr> "東北", "関東信越", "四国", "近畿", "中国"
[2024/08/06 17:54:18] $ url         <chr> "https://kouseikyoku.mhlw.go.jp/tohoku/gyomu/gyomu/hoken_k…
[2024/08/06 17:54:18] $ contains_jp <chr> "Excel（ZIP）", "医科（ZIP）", "（ZIP）", "（ZIP）", "各県…
[2024/08/06 17:54:18] $ a_con       <chr> "a:contains('Excel（ZIP）')", "a:contains('医科（ZIP）')",…
[2024/08/06 17:54:18] 
[2024/08/06 17:54:18] > get_sisetukijun1 <- function(district, url, a_contains) {
[2024/08/06 17:54:18] +     output_dir1 <- str_glue("{original_dir}/{district}") %>% 
[2024/08/06 17:54:18] +         print()
[2024/08/06 17:54:18] +     if .... [TRUNCATED] 
[2024/08/06 17:54:18] 
[2024/08/06 17:54:18] > for (i in 1:nrow(df_kouseikyoku)) {
[2024/08/06 17:54:18] +     district <- df_kouseikyoku$district[i]
[2024/08/06 17:54:18] +     url <- df_kouseikyoku$url[i]
[2024/08/06 17:54:18] +     a_contains <- df_kouseikyo .... [TRUNCATED] 
[2024/08/06 17:54:18] /home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/東北
[2024/08/06 17:54:18]  URL 'https://kouseikyoku.mhlw.go.jp/tohoku/todokede_zentai_ika_r0607.zip' を試しています 
[2024/08/06 17:54:18] Content type 'application/zip' length 3810704 bytes (3.6 MB)
[2024/08/06 17:54:18] ==================================================
[2024/08/06 17:54:18] downloaded 3.6 MB
[2024/08/06 17:54:18] 
[2024/08/06 17:54:18] Archive:  downloads/todokede_zentai_ika_r0607.zip
[2024/08/06 17:54:18]    creating: /tmp/RtmpRD8Mpw/todokede_zentai_ika_r0607/
[2024/08/06 17:54:18]   inflating: /tmp/RtmpRD8Mpw/todokede_zentai_ika_r0607/届出受理医療機関名簿（医科）r0607.xlsx  
[2024/08/06 17:54:18] /home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/関東信越
[2024/08/06 17:54:18]  URL 'https://kouseikyoku.mhlw.go.jp/kantoshinetsu/chousa/shisetsu_ika_r0607.zip' を試しています 
[2024/08/06 17:54:18] Content type 'application/zip' length 16126374 bytes (15.4 MB)
[2024/08/06 17:54:18] ==================================================
[2024/08/06 17:54:18] downloaded 15.4 MB
[2024/08/06 17:54:18] 
[2024/08/06 17:54:18] Archive:  downloads/shisetsu_ika_r0607.zip
[2024/08/06 17:54:18]    creating: /tmp/RtmpRD8Mpw/shisetsu_ika_r0607/
[2024/08/06 17:54:18]   inflating: /tmp/RtmpRD8Mpw/shisetsu_ika_r0607/08届出受理医療機関名簿（医科）茨城r0607.xlsx  
[2024/08/06 17:54:18]   inflating: /tmp/RtmpRD8Mpw/shisetsu_ika_r0607/09届出受理医療機関名簿（医科）栃木r0607.xlsx  
[2024/08/06 17:54:18]   inflating: /tmp/RtmpRD8Mpw/shisetsu_ika_r0607/10届出受理医療機関名簿（医科）群馬r0607.xlsx  
[2024/08/06 17:54:18]   inflating: /tmp/RtmpRD8Mpw/shisetsu_ika_r0607/11届出受理医療機関名簿（医科）埼玉r0607.xlsx  
[2024/08/06 17:54:18]   inflating: /tmp/RtmpRD8Mpw/shisetsu_ika_r0607/12届出受理医療機関名簿（医科）千葉r0607.xlsx  
[2024/08/06 17:54:18]   inflating: /tmp/RtmpRD8Mpw/shisetsu_ika_r0607/13届出受理医療機関名簿（医科）東京r0607.xlsx  
[2024/08/06 17:54:18]   inflating: /tmp/RtmpRD8Mpw/shisetsu_ika_r0607/14届出受理医療機関名簿（医科）神奈川r0607.xlsx  
[2024/08/06 17:54:18]   inflating: /tmp/RtmpRD8Mpw/shisetsu_ika_r0607/15届出受理医療機関名簿（医科）新潟r0607.xlsx  
[2024/08/06 17:54:18]   inflating: /tmp/RtmpRD8Mpw/shisetsu_ika_r0607/19届出受理医療機関名簿（医科）山梨r0607.xlsx  
[2024/08/06 17:54:18]   inflating: /tmp/RtmpRD8Mpw/shisetsu_ika_r0607/20届出受理医療機関名簿（医科）長野r0607.xlsx  
[2024/08/06 17:54:18] /home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/四国
[2024/08/06 17:54:18]  URL 'https://kouseikyoku.mhlw.go.jp/shikoku/gyomu/gyomu/hoken_kikan/shitei/000343234.zip' を試しています 
[2024/08/06 17:54:18] Content type 'application/zip' length 3973277 bytes (3.8 MB)
[2024/08/06 17:54:18] ==================================================
[2024/08/06 17:54:18] downloaded 3.8 MB
[2024/08/06 17:54:18] 
[2024/08/06 17:54:18] Archive:  downloads/000343234.zip
[2024/08/06 17:54:24]   inflating: /tmp/RtmpRD8Mpw/02_01　香川　医科　届出受理医療機関名簿.xlsx  
[2024/08/06 17:54:24]   inflating: /tmp/RtmpRD8Mpw/02_04　徳島　医科　届出受理医療機関名簿.xlsx  
[2024/08/06 17:54:24]   inflating: /tmp/RtmpRD8Mpw/02_07　愛媛　医科　届出受理医療機関名簿.xlsx  
[2024/08/06 17:54:24]   inflating: /tmp/RtmpRD8Mpw/02_10　高知　医科　届出受理医療機関名簿.xlsx  
[2024/08/06 17:54:24] /home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/近畿
[2024/08/06 17:54:24]  URL 'https://kouseikyoku.mhlw.go.jp/kinki/gyomu/gyomu/hoken_kikan/2024.8_sisetukijun_ika.zip' を試しています 
[2024/08/06 17:54:24] Content type 'application/zip' length 9568265 bytes (9.1 MB)
[2024/08/06 17:54:24] ==================================================
[2024/08/06 17:54:24] downloaded 9.1 MB
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] Archive:  downloads/2024.8_sisetukijun_ika.zip
[2024/08/06 17:54:24]    creating: /tmp/RtmpRD8Mpw/2024.8_sisetukijun_ika/
[2024/08/06 17:54:24]   inflating: /tmp/RtmpRD8Mpw/2024.8_sisetukijun_ika/2024.8_sisetukijun_fukui_ika.xlsx  
[2024/08/06 17:54:24]   inflating: /tmp/RtmpRD8Mpw/2024.8_sisetukijun_ika/2024.8_sisetukijun_hyogo_ika.xlsx  
[2024/08/06 17:54:24]   inflating: /tmp/RtmpRD8Mpw/2024.8_sisetukijun_ika/2024.8_sisetukijun_kyoto_ika.xlsx  
[2024/08/06 17:54:24]   inflating: /tmp/RtmpRD8Mpw/2024.8_sisetukijun_ika/2024.8_sisetukijun_nara_ika.xlsx  
[2024/08/06 17:54:24]   inflating: /tmp/RtmpRD8Mpw/2024.8_sisetukijun_ika/2024.8_sisetukijun_osaka_ika.xlsx  
[2024/08/06 17:54:24]   inflating: /tmp/RtmpRD8Mpw/2024.8_sisetukijun_ika/2024.8_sisetukijun_shiga_ika.xlsx  
[2024/08/06 17:54:24]   inflating: /tmp/RtmpRD8Mpw/2024.8_sisetukijun_ika/2024.8_sisetukijun_wakayama_ika.xlsx  
[2024/08/06 17:54:24] /home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/中国
[2024/08/06 17:54:24]  URL 'https://kouseikyoku.mhlw.go.jp/chugokushikoku/chousaka/000343809.zip' を試しています 
[2024/08/06 17:54:24] Content type 'application/zip' length 6972491 bytes (6.6 MB)
[2024/08/06 17:54:24] ==================================================
[2024/08/06 17:54:24] downloaded 6.6 MB
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] Archive:  downloads/000343809.zip
[2024/08/06 17:54:24]   inflating: /tmp/RtmpRD8Mpw/31_鳥取_届出受理医療機関名簿.xlsx  
[2024/08/06 17:54:24]   inflating: /tmp/RtmpRD8Mpw/32_島根_届出受理医療機関名簿.xlsx  
[2024/08/06 17:54:24]   inflating: /tmp/RtmpRD8Mpw/33_岡山_届出受理医療機関名簿.xlsx  
[2024/08/06 17:54:24]   inflating: /tmp/RtmpRD8Mpw/34_広島_届出受理医療機関名簿.xlsx  
[2024/08/06 17:54:24]   inflating: /tmp/RtmpRD8Mpw/35_山口_届出受理医療機関名簿.xlsx  
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > url <- "https://kouseikyoku.mhlw.go.jp/hokkaido/gyomu/gyomu/hoken_kikan/todokede_juri_ichiran.html"
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > webpage <- read_html(url)
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > links <- webpage %>% html_nodes("a") %>% html_attr("href")
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > excel_links <- links[grepl("\\.xlsx$", links)]
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > if (length(excel_links) == 0) {
[2024/08/06 17:54:24] +     stop("エクセルファイルのリンクが見つかりませんでした。")
[2024/08/06 17:54:24] + }
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > downloaded_files <- c()
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > for (link in excel_links) {
[2024/08/06 17:54:24] +     download_link <- paste0("https://kouseikyoku.mhlw.go.jp", 
[2024/08/06 17:54:24] +         link)
[2024/08/06 17:54:24] +     file_name <- basename(link)
[2024/08/06 17:54:24] +     .... [TRUNCATED] 
[2024/08/06 17:54:24] 000341730.xlsx のダウンロードが完了しました。
[2024/08/06 17:54:24] 000341732.xlsx のダウンロードが完了しました。
[2024/08/06 17:54:24] 000341734.xlsx のダウンロードが完了しました。
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > file_sizes <- sapply(downloaded_files, file.size)
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > largest_file <- downloaded_files[which.max(file_sizes)]
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > cat("最大ファイルは:", largest_file, "です。\n")
[2024/08/06 17:54:24] 最大ファイルは: 000341730.xlsx です。
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > output_dir2 <- str_glue("{original_dir}/北海道")
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > if (!dir.exists(output_dir2)) {
[2024/08/06 17:54:24] +     dir.create(output_dir2)
[2024/08/06 17:54:24] + }
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > file.copy(largest_file, output_dir2, overwrite = TRUE)
[2024/08/06 17:54:24] [1] TRUE
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > sapply(downloaded_files, file.remove)
[2024/08/06 17:54:24] 000341730.xlsx 000341732.xlsx 000341734.xlsx 
[2024/08/06 17:54:24]           TRUE           TRUE           TRUE 
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > url <- "https://kouseikyoku.mhlw.go.jp/tokaihokuriku/newpage_00349.html"
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > webpage <- read_html(url)
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > links <- webpage %>% html_nodes("a") %>% .[str_detect(html_text(.), 
[2024/08/06 17:54:24] +     "^届出受理医療機関名簿（医科）")] %>% html_attr("href")
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > first_link <- links[1]
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > file_url <- paste0("https://kouseikyoku.mhlw.go.jp", 
[2024/08/06 17:54:24] +     first_link)
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > download_dir <- "downloads"
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > if (!dir.exists(download_dir)) {
[2024/08/06 17:54:24] +     dir.create(download_dir)
[2024/08/06 17:54:24] + }
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > zip_filename <- basename(file_url)
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > zip_filepath <- file.path(download_dir, zip_filename)
[2024/08/06 17:54:24] 
[2024/08/06 17:54:24] > download.file(file_url, zip_filepath)
[2024/08/06 17:54:32]  URL 'https://kouseikyoku.mhlw.go.jp/tokaihokuriku/2408-06_01-01.zip' を試しています 
[2024/08/06 17:54:32] Content type 'application/zip' length 9644045 bytes (9.2 MB)
[2024/08/06 17:54:32] ==================================================
[2024/08/06 17:54:32] downloaded 9.2 MB
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32] > unzip_dir <- tempdir() %>% print()
[2024/08/06 17:54:32] [1] "/tmp/RtmpRD8Mpw"
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32] > unlink(unzip_dir, recursive = TRUE)
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32] > zip_command <- paste("unzip", shQuote(zip_filepath), 
[2024/08/06 17:54:32] +     "-d", shQuote(unzip_dir))
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32] > system(zip_command)
[2024/08/06 17:54:32] Archive:  downloads/2408-06_01-01.zip
[2024/08/06 17:54:32]    creating: /tmp/RtmpRD8Mpw/2408　届出受理医療機関名簿（医科）/
[2024/08/06 17:54:32]   inflating: /tmp/RtmpRD8Mpw/2408　届出受理医療機関名簿（医科）/2408（三重）届出受理医療機関名簿.xlsx  
[2024/08/06 17:54:32]   inflating: /tmp/RtmpRD8Mpw/2408　届出受理医療機関名簿（医科）/2408（富山）届出受理医療機関名簿.xlsx  
[2024/08/06 17:54:32]   inflating: /tmp/RtmpRD8Mpw/2408　届出受理医療機関名簿（医科）/2408（岐阜）届出受理医療機関名簿.xlsx  
[2024/08/06 17:54:32]   inflating: /tmp/RtmpRD8Mpw/2408　届出受理医療機関名簿（医科）/2408（愛知）届出受理医療機関名簿.xlsx  
[2024/08/06 17:54:32]   inflating: /tmp/RtmpRD8Mpw/2408　届出受理医療機関名簿（医科）/2408（石川）届出受理医療機関名簿.xlsx  
[2024/08/06 17:54:32]   inflating: /tmp/RtmpRD8Mpw/2408　届出受理医療機関名簿（医科）/2408（静岡）届出受理医療機関名簿.xlsx  
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32] > unzip_subdirs <- list.dirs(unzip_dir, recursive = TRUE) %>% 
[2024/08/06 17:54:32] +     print()
[2024/08/06 17:54:32] [1] "/tmp/RtmpRD8Mpw"                                   
[2024/08/06 17:54:32] [2] "/tmp/RtmpRD8Mpw/2408　届出受理医療機関名簿（医科）"
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32] > output_dir3 <- str_glue("{original_dir}/東海")
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32] > if (!dir.exists(output_dir3)) {
[2024/08/06 17:54:32] +     dir.create(output_dir3)
[2024/08/06 17:54:32] + }
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32] > for (subdir in unzip_subdirs) {
[2024/08/06 17:54:32] +     excel_files <- list.files(subdir, pattern = "\\.xls(x)?$", 
[2024/08/06 17:54:32] +         full.names = TRUE)
[2024/08/06 17:54:32] +     if (length(exce .... [TRUNCATED] 
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32] > unlink(download_dir, recursive = TRUE)
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32] > url <- "https://kouseikyoku.mhlw.go.jp/kyushu/gyomu/gyomu/hoken_kikan/index_00007.html"
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32] > web_page <- read_html(url)
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32] > links <- web_page %>% html_nodes("a:contains('エクセルデータ（ZIP）')") %>% 
[2024/08/06 17:54:32] +     html_attr("href")
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32] > latest_prefix <- max(gsub("^.*/([^_]+_[0-9]+)_.*$", 
[2024/08/06 17:54:32] +     "\\1", links))
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32] > download_dir <- "downloads"
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32] > if (!dir.exists(download_dir)) {
[2024/08/06 17:54:32] +     dir.create(download_dir)
[2024/08/06 17:54:32] + }
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32] > latest_links <- links[grepl(paste0(latest_prefix), 
[2024/08/06 17:54:32] +     links)]
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32] > for (link in latest_links) {
[2024/08/06 17:54:32] +     zip_url <- paste0("https://kouseikyoku.mhlw.go.jp", link)
[2024/08/06 17:54:32] +     zip_filename <- basename(zip_url)
[2024/08/06 17:54:32] +     zip_filep .... [TRUNCATED] 
[2024/08/06 17:54:32]  URL 'https://kouseikyoku.mhlw.go.jp/kyushu/gyomu/gyomu/hoken_kikan/r6_07_shisetsu_fukuoka.zip' を試しています 
[2024/08/06 17:54:32] Content type 'application/zip' length 6380830 bytes (6.1 MB)
[2024/08/06 17:54:32] ==================================================
[2024/08/06 17:54:32] downloaded 6.1 MB
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32]  URL 'https://kouseikyoku.mhlw.go.jp/kyushu/gyomu/gyomu/hoken_kikan/r6_07_shisetsu_saga.zip' を試しています 
[2024/08/06 17:54:32] Content type 'application/zip' length 1162249 bytes (1.1 MB)
[2024/08/06 17:54:32] ==================================================
[2024/08/06 17:54:32] downloaded 1.1 MB
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32]  URL 'https://kouseikyoku.mhlw.go.jp/kyushu/gyomu/gyomu/hoken_kikan/r6_07_shisetsu_nagasaki.zip' を試しています 
[2024/08/06 17:54:32] Content type 'application/zip' length 1772201 bytes (1.7 MB)
[2024/08/06 17:54:32] ==================================================
[2024/08/06 17:54:32] downloaded 1.7 MB
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32]  URL 'https://kouseikyoku.mhlw.go.jp/kyushu/gyomu/gyomu/hoken_kikan/r6_07_shisetsu_kumamoto.zip' を試しています 
[2024/08/06 17:54:32] Content type 'application/zip' length 2296752 bytes (2.2 MB)
[2024/08/06 17:54:32] ==================================================
[2024/08/06 17:54:32] downloaded 2.2 MB
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32]  URL 'https://kouseikyoku.mhlw.go.jp/kyushu/gyomu/gyomu/hoken_kikan/r6_07_shisetsu_ooita.zip' を試しています 
[2024/08/06 17:54:32] Content type 'application/zip' length 1550408 bytes (1.5 MB)
[2024/08/06 17:54:32] ==================================================
[2024/08/06 17:54:32] downloaded 1.5 MB
[2024/08/06 17:54:32] 
[2024/08/06 17:54:32]  URL 'https://kouseikyoku.mhlw.go.jp/kyushu/gyomu/gyomu/hoken_kikan/r6_07_shisetsu_miyazaki.zip' を試しています 
[2024/08/06 17:54:32] Content type 'application/zip' length 1346466 bytes (1.3 MB)
[2024/08/06 17:54:32] ==================================================
[2024/08/06 17:54:32] downloaded 1.3 MB
[2024/08/06 17:54:32] 
[2024/08/06 17:54:36]  URL 'https://kouseikyoku.mhlw.go.jp/kyushu/gyomu/gyomu/hoken_kikan/r6_07_shisetsu_kagoshima.zip' を試しています 
[2024/08/06 17:54:36] Content type 'application/zip' length 2205816 bytes (2.1 MB)
[2024/08/06 17:54:36] ==================================================
[2024/08/06 17:54:36] downloaded 2.1 MB
[2024/08/06 17:54:36] 
[2024/08/06 17:54:36]  URL 'https://kouseikyoku.mhlw.go.jp/kyushu/gyomu/gyomu/hoken_kikan/r6_07_shisetsu_okinawa.zip' を試しています 
[2024/08/06 17:54:36] Content type 'application/zip' length 1224013 bytes (1.2 MB)
[2024/08/06 17:54:36] ==================================================
[2024/08/06 17:54:36] downloaded 1.2 MB
[2024/08/06 17:54:36] 
[2024/08/06 17:54:36] 
[2024/08/06 17:54:36] > list.files("./downloads")
[2024/08/06 17:54:36] [1] "r6_07_shisetsu_fukuoka.zip"   "r6_07_shisetsu_kagoshima.zip"
[2024/08/06 17:54:36] [3] "r6_07_shisetsu_kumamoto.zip"  "r6_07_shisetsu_miyazaki.zip" 
[2024/08/06 17:54:36] [5] "r6_07_shisetsu_nagasaki.zip"  "r6_07_shisetsu_okinawa.zip"  
[2024/08/06 17:54:36] [7] "r6_07_shisetsu_ooita.zip"     "r6_07_shisetsu_saga.zip"     
[2024/08/06 17:54:36] 
[2024/08/06 17:54:36] > unzip_dir <- "unzipped"
[2024/08/06 17:54:36] 
[2024/08/06 17:54:36] > if (!dir.exists(unzip_dir)) {
[2024/08/06 17:54:36] +     dir.create(unzip_dir)
[2024/08/06 17:54:36] + }
[2024/08/06 17:54:36] 
[2024/08/06 17:54:36] > target_dir <- "target_files"
[2024/08/06 17:54:36] 
[2024/08/06 17:54:36] > if (!dir.exists(target_dir)) {
[2024/08/06 17:54:36] +     dir.create(target_dir)
[2024/08/06 17:54:36] + }
[2024/08/06 17:54:36] 
[2024/08/06 17:54:36] > output_dir4 <- str_glue("{original_dir}/九州")
[2024/08/06 17:54:36] 
[2024/08/06 17:54:36] > if (!dir.exists(output_dir4)) {
[2024/08/06 17:54:36] +     dir.create(output_dir4)
[2024/08/06 17:54:36] + }
[2024/08/06 17:54:36] 
[2024/08/06 17:54:36] > zip_files <- list.files(download_dir, pattern = "\\.zip$", 
[2024/08/06 17:54:36] +     full.names = TRUE)
[2024/08/06 17:54:36] 
[2024/08/06 17:54:36] > for (zip_file in zip_files) {
[2024/08/06 17:54:36] +     unzip(zip_file, exdir = unzip_dir)
[2024/08/06 17:54:36] +     files <- list.files(unzip_dir, pattern = str_c(latest_prefix, 
[2024/08/06 17:54:36] +        .... [TRUNCATED] 
[2024/08/06 17:54:36] 
[2024/08/06 17:54:36] > unlink(download_dir, recursive = TRUE)
[2024/08/06 17:54:36] 
[2024/08/06 17:54:36] > unlink(unzip_dir, recursive = TRUE)
[2024/08/06 17:54:36] 
[2024/08/06 17:54:36] > unlink(target_dir, recursive = TRUE)
[2024/08/06 17:54:36] 
[2024/08/06 17:54:36] > files <- list.files(original_dir, full.names = TRUE, 
[2024/08/06 17:54:36] +     recursive = TRUE, pattern = ".xlsx$") %>% print()
[2024/08/06 17:54:36]  [1] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/関東信越/08届出受理医療機関名簿（医科）茨城r0607.xlsx"  
[2024/08/06 17:54:36]  [2] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/関東信越/09届出受理医療機関名簿（医科）栃木r0607.xlsx"  
[2024/08/06 17:54:36]  [3] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/関東信越/10届出受理医療機関名簿（医科）群馬r0607.xlsx"  
[2024/08/06 17:54:36]  [4] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/関東信越/11届出受理医療機関名簿（医科）埼玉r0607.xlsx"  
[2024/08/06 17:54:36]  [5] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/関東信越/12届出受理医療機関名簿（医科）千葉r0607.xlsx"  
[2024/08/06 17:54:36]  [6] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/関東信越/13届出受理医療機関名簿（医科）東京r0607.xlsx"  
[2024/08/06 17:54:36]  [7] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/関東信越/14届出受理医療機関名簿（医科）神奈川r0607.xlsx"
[2024/08/06 17:54:36]  [8] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/関東信越/15届出受理医療機関名簿（医科）新潟r0607.xlsx"  
[2024/08/06 17:54:36]  [9] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/関東信越/19届出受理医療機関名簿（医科）山梨r0607.xlsx"  
[2024/08/06 17:54:36] [10] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/関東信越/20届出受理医療機関名簿（医科）長野r0607.xlsx"  
[2024/08/06 17:54:36] [11] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/近畿/2024.8_sisetukijun_fukui_ika.xlsx"                 
[2024/08/06 17:54:36] [12] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/近畿/2024.8_sisetukijun_hyogo_ika.xlsx"                 
[2024/08/06 17:54:36] [13] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/近畿/2024.8_sisetukijun_kyoto_ika.xlsx"                 
[2024/08/06 17:54:36] [14] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/近畿/2024.8_sisetukijun_nara_ika.xlsx"                  
[2024/08/06 17:54:36] [15] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/近畿/2024.8_sisetukijun_osaka_ika.xlsx"                 
[2024/08/06 17:54:36] [16] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/近畿/2024.8_sisetukijun_shiga_ika.xlsx"                 
[2024/08/06 17:54:36] [17] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/近畿/2024.8_sisetukijun_wakayama_ika.xlsx"              
[2024/08/06 17:54:36] [18] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/九州/r6_07_shisetsu_fukuoka_ika_02.xlsx"                
[2024/08/06 17:54:36] [19] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/九州/r6_07_shisetsu_kagoshima_ika_02.xlsx"              
[2024/08/06 17:54:36] [20] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/九州/r6_07_shisetsu_kumamoto_ika_02.xlsx"               
[2024/08/06 17:54:36] [21] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/九州/r6_07_shisetsu_miyazaki_ika_02.xlsx"               
[2024/08/06 17:54:36] [22] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/九州/r6_07_shisetsu_nagasaki_ika_02.xlsx"               
[2024/08/06 17:54:36] [23] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/九州/r6_07_shisetsu_okinawa_ika_02.xlsx"                
[2024/08/06 17:54:36] [24] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/九州/r6_07_shisetsu_ooita_ika_02.xlsx"                  
[2024/08/06 17:54:36] [25] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/九州/r6_07_shisetsu_saga_ika_02.xlsx"                   
[2024/08/06 17:54:36] [26] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/四国/02_01　香川　医科　届出受理医療機関名簿.xlsx"      
[2024/08/06 17:54:36] [27] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/四国/02_04　徳島　医科　届出受理医療機関名簿.xlsx"      
[2024/08/06 17:54:36] [28] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/四国/02_07　愛媛　医科　届出受理医療機関名簿.xlsx"      
[2024/08/06 17:54:36] [29] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/四国/02_10　高知　医科　届出受理医療機関名簿.xlsx"      
[2024/08/06 17:54:36] [30] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/中国/31_鳥取_届出受理医療機関名簿.xlsx"                 
[2024/08/06 17:54:36] [31] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/中国/32_島根_届出受理医療機関名簿.xlsx"                 
[2024/08/06 17:54:36] [32] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/中国/33_岡山_届出受理医療機関名簿.xlsx"                 
[2024/08/06 17:54:36] [33] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/中国/34_広島_届出受理医療機関名簿.xlsx"                 
[2024/08/06 17:54:36] [34] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/中国/35_山口_届出受理医療機関名簿.xlsx"                 
[2024/08/06 17:54:36] [35] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/東海/2408（愛知）届出受理医療機関名簿.xlsx"             
[2024/08/06 17:54:36] [36] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/東海/2408（岐阜）届出受理医療機関名簿.xlsx"             
[2024/08/06 17:54:36] [37] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/東海/2408（三重）届出受理医療機関名簿.xlsx"             
[2024/08/06 17:54:36] [38] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/東海/2408（静岡）届出受理医療機関名簿.xlsx"             
[2024/08/06 17:54:36] [39] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/東海/2408（石川）届出受理医療機関名簿.xlsx"             
[2024/08/06 17:54:36] [40] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/東海/2408（富山）届出受理医療機関名簿.xlsx"             
[2024/08/06 17:54:36] [41] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/東北/届出受理医療機関名簿（医科）r0607.xlsx"            
[2024/08/06 17:54:36] [42] "/home/rstudio/srv/project/20240806_施設基準取得/output/20240806/original/北海道/000341730.xlsx"                                  
[2024/08/06 17:54:36] 
[2024/08/06 17:54:36] > file <- files[1]
[2024/08/06 17:54:36] 
[2024/08/06 17:54:36] > sheet <- "Sheet1"
[2024/08/06 17:54:36] 
[2024/08/06 17:54:36] > read_sisetukijun_xlsx <- function(file, sheet) {
[2024/08/06 17:55:23] +     readxl::read_excel(file, skip = 3, sheet = sheet, col_types = "text") %>% 
[2024/08/06 17:55:23] +         tibble() .... [TRUNCATED] 
[2024/08/06 17:55:23] 
[2024/08/06 17:55:23] > df_file <- dplyr::tibble(file = files) %>% mutate(get_date = str_extract(file, 
[2024/08/06 17:55:23] +     "output/[0-9]{8}")) %>% mutate(get_date = str_extract(get_date .... [TRUNCATED] 
[2024/08/06 17:55:23] mutate: new variable 'get_date' (character) with one unique value and 0% NA
[2024/08/06 17:55:23] mutate: changed 42 values (100%) of 'get_date' (0 new NA)
[2024/08/06 17:55:23] mutate: converted 'get_date' from character to Date (0 new NA)
[2024/08/06 17:55:23] mutate: new variable 'sheet' (list) with 2 unique values and 0% NA
[2024/08/06 17:55:23] # A tibble: 47 × 3
[2024/08/06 17:55:23]    file                                                         get_date   sheet
[2024/08/06 17:55:23]    <chr>                                                        <date>     <chr>
[2024/08/06 17:55:23]  1 /home/rstudio/srv/project/20240806_施設基準取得/output/2024… 2024-08-06 Shee…
[2024/08/06 17:55:23]  2 /home/rstudio/srv/project/20240806_施設基準取得/output/2024… 2024-08-06 Shee…
[2024/08/06 17:55:23]  3 /home/rstudio/srv/project/20240806_施設基準取得/output/2024… 2024-08-06 Shee…
[2024/08/06 17:55:23]  4 /home/rstudio/srv/project/20240806_施設基準取得/output/2024… 2024-08-06 Shee…
[2024/08/06 17:55:23]  5 /home/rstudio/srv/project/20240806_施設基準取得/output/2024… 2024-08-06 Shee…
[2024/08/06 17:55:23]  6 /home/rstudio/srv/project/20240806_施設基準取得/output/2024… 2024-08-06 Shee…
[2024/08/06 17:55:23]  7 /home/rstudio/srv/project/20240806_施設基準取得/output/2024… 2024-08-06 Shee…
[2024/08/06 17:55:23]  8 /home/rstudio/srv/project/20240806_施設基準取得/output/2024… 2024-08-06 Shee…
[2024/08/06 17:55:23]  9 /home/rstudio/srv/project/20240806_施設基準取得/output/2024… 2024-08-06 Shee…
[2024/08/06 17:55:23] 10 /home/rstudio/srv/project/20240806_施設基準取得/output/2024… 2024-08-06 Shee…
[2024/08/06 17:55:23] # ℹ 37 more rows
[2024/08/06 17:55:23] 
[2024/08/06 17:55:23] > df_file <- df_file %>% mutate(data = map2(file, sheet, 
[2024/08/06 17:55:23] +     read_sisetukijun_xlsx)) %>% print()
[2024/08/06 17:55:23] mutate: new variable 'data' (list) with 47 unique values and 0% NA
[2024/08/06 17:55:23] # A tibble: 47 × 4
[2024/08/06 17:55:23]    file                                                get_date   sheet data    
[2024/08/06 17:55:23]    <chr>                                               <date>     <chr> <list>  
[2024/08/06 17:55:23]  1 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:23]  2 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:23]  3 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:23]  4 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:23]  5 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:23]  6 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:23]  7 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:23]  8 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:23]  9 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:23] 10 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:23] # ℹ 37 more rows
[2024/08/06 17:55:23] 
[2024/08/06 17:55:23] > df_file <- df_file %>% mutate(data = map2(data, get_date, 
[2024/08/06 17:55:23] +     ~mutate(.x, get_date = .y))) %>% print()
[2024/08/06 17:55:23] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:23] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:23] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:23] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:23] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:23] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:23] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:23] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:23] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:23] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:23] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:23] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:23] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:23] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: new variable 'get_date' (Date) with one unique value and 0% NA
[2024/08/06 17:55:25] mutate: changed 47 values (100%) of 'data' (0 new NA)
[2024/08/06 17:55:25] # A tibble: 47 × 4
[2024/08/06 17:55:25]    file                                                get_date   sheet data    
[2024/08/06 17:55:25]    <chr>                                               <date>     <chr> <list>  
[2024/08/06 17:55:25]  1 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:25]  2 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:25]  3 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:25]  4 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:25]  5 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:25]  6 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:25]  7 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:25]  8 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:25]  9 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:25] 10 /home/rstudio/srv/project/20240806_施設基準取得/ou… 2024-08-06 Shee… <tibble>
[2024/08/06 17:55:25] # ℹ 37 more rows
[2024/08/06 17:55:25] 
[2024/08/06 17:55:25] > df_all <- df_file %>% select(data) %>% unnest(cols = c(data)) %>% 
[2024/08/06 17:55:25] +     print()
[2024/08/06 17:55:25] select: dropped 3 variables (file, get_date, sheet)
[2024/08/06 17:55:25] # A tibble: 991,755 × 25
[2024/08/06 17:55:25]    項番  都道府県コード 都道府県名 区分  医療機関番号 併設医療機関番号
[2024/08/06 17:55:25]    <chr> <chr>          <chr>      <chr> <chr>        <chr>           
[2024/08/06 17:55:25]  1 1     08             茨城県     医科  0110056      <NA>            
[2024/08/06 17:55:25]  2 1     08             茨城県     医科  0110056      <NA>            
[2024/08/06 17:55:25]  3 1     08             茨城県     医科  0110056      <NA>            
[2024/08/06 17:56:37]  4 1     08             茨城県     医科  0110056      <NA>            
[2024/08/06 17:56:37]  5 1     08             茨城県     医科  0110056      <NA>            
[2024/08/06 17:56:37]  6 1     08             茨城県     医科  0110056      <NA>            
[2024/08/06 17:56:37]  7 1     08             茨城県     医科  0110056      <NA>            
[2024/08/06 17:56:37]  8 1     08             茨城県     医科  0110056      <NA>            
[2024/08/06 17:56:37]  9 1     08             茨城県     医科  0110056      <NA>            
[2024/08/06 17:56:37] 10 1     08             茨城県     医科  0110056      <NA>            
[2024/08/06 17:56:37] # ℹ 991,745 more rows
[2024/08/06 17:56:37] # ℹ 19 more variables: 医療機関記号番号 <chr>, 医療機関名称 <chr>,
[2024/08/06 17:56:37] #   `医療機関所在地（郵便番号）` <chr>, `医療機関所在地（住所）` <chr>,
[2024/08/06 17:56:37] #   電話番号 <chr>, FAX番号 <chr>, 病床数 <chr>, 受理届出名称 <chr>,
[2024/08/06 17:56:37] #   受理記号 <chr>, 受理番号 <chr>, 算定開始年月日 <chr>,
[2024/08/06 17:56:37] #   個別有効開始年月日 <chr>, `備考（見出し）` <chr>, `備考（データ）` <chr>,
[2024/08/06 17:56:37] #   市町村コード <chr>, 市町村名 <chr>, 種別コード <chr>, 種別 <chr>, …
[2024/08/06 17:56:37] 
[2024/08/06 17:56:37] > df_all <- df_all %>% mutate(西暦算定開始年月日 = zipangu::convert_jdate(str_replace_all(算定開始年月日, 
[2024/08/06 17:56:37] +     " ", "")), .after = 算定開始年月日) %>% glimpse()
[2024/08/06 17:56:37] mutate: new variable '西暦算定開始年月日' (Date) with 3,684 unique values and 1% NA
[2024/08/06 17:56:37] Rows: 991,755
[2024/08/06 17:56:37] Columns: 26
[2024/08/06 17:56:37] $ 項番                         <chr> "1", "1", "1", "1", "1", "1", "1", "1", "…
[2024/08/06 17:56:37] $ 都道府県コード               <chr> "08", "08", "08", "08", "08", "08", "08",…
[2024/08/06 17:56:37] $ 都道府県名                   <chr> "茨城県", "茨城県", "茨城県", "茨城県", "…
[2024/08/06 17:56:37] $ 区分                         <chr> "医科", "医科", "医科", "医科", "医科", "…
[2024/08/06 17:56:37] $ 医療機関番号                 <chr> "0110056", "0110056", "0110056", "0110056…
[2024/08/06 17:56:37] $ 併設医療機関番号             <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:37] $ 医療機関記号番号             <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:37] $ 医療機関名称                 <chr> "水戸赤十字病院", "水戸赤十字病院", "水戸…
[2024/08/06 17:56:37] $ `医療機関所在地（郵便番号）` <chr> "310-0011", "310-0011", "310-0011", "310-…
[2024/08/06 17:56:37] $ `医療機関所在地（住所）`     <chr> "水戸市三の丸３－１２－４８", "水戸市三の…
[2024/08/06 17:56:37] $ 電話番号                     <chr> "029-221-5177", "029-221-5177", "029-221-…
[2024/08/06 17:56:37] $ FAX番号                      <chr> "029-227-0819", "029-227-0819", "029-227-…
[2024/08/06 17:56:37] $ 病床数                       <chr> "一般　　378／一般（感染）　感染　9", "一…
[2024/08/06 17:56:37] $ 受理届出名称                 <chr> "医療ＤＸ推進体制整備加算", "一般病棟入院…
[2024/08/06 17:56:37] $ 受理記号                     <chr> "医療ＤＸ", "一般入院", "救急医療", "超急…
[2024/08/06 17:56:37] $ 受理番号                     <chr> "第494号", "第134号", "第21号", "第2号", …
[2024/08/06 17:56:37] $ 算定開始年月日               <chr> "令和 6年 6月 1日", "令和 6年 6月 1日", "…
[2024/08/06 17:56:37] $ 西暦算定開始年月日           <date> 2024-06-01, 2024-06-01, 2020-04-01, 2008…
[2024/08/06 17:56:37] $ 個別有効開始年月日           <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:37] $ `備考（見出し）`             <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:37] $ `備考（データ）`             <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:37] $ 市町村コード                 <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:37] $ 市町村名                     <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:37] $ 種別コード                   <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:37] $ 種別                         <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:37] $ get_date                     <date> 2024-08-06, 2024-08-06, 2024-08-06, 2024…
[2024/08/06 17:56:37] 
[2024/08/06 17:56:37] > df_all %>% filter(is.na(西暦算定開始年月日), 
[2024/08/06 17:56:37] +     !is.na(算定開始年月日)) %>% glimpse()
[2024/08/06 17:56:37] filter: removed all rows (100%)
[2024/08/06 17:56:37] Rows: 0
[2024/08/06 17:56:37] Columns: 26
[2024/08/06 17:56:37] $ 項番                         <chr> 
[2024/08/06 17:56:37] $ 都道府県コード               <chr> 
[2024/08/06 17:56:37] $ 都道府県名                   <chr> 
[2024/08/06 17:56:39] $ 区分                         <chr> 
[2024/08/06 17:56:39] $ 医療機関番号                 <chr> 
[2024/08/06 17:56:39] $ 併設医療機関番号             <chr> 
[2024/08/06 17:56:39] $ 医療機関記号番号             <chr> 
[2024/08/06 17:56:39] $ 医療機関名称                 <chr> 
[2024/08/06 17:56:39] $ `医療機関所在地（郵便番号）` <chr> 
[2024/08/06 17:56:39] $ `医療機関所在地（住所）`     <chr> 
[2024/08/06 17:56:39] $ 電話番号                     <chr> 
[2024/08/06 17:56:39] $ FAX番号                      <chr> 
[2024/08/06 17:56:39] $ 病床数                       <chr> 
[2024/08/06 17:56:39] $ 受理届出名称                 <chr> 
[2024/08/06 17:56:39] $ 受理記号                     <chr> 
[2024/08/06 17:56:39] $ 受理番号                     <chr> 
[2024/08/06 17:56:39] $ 算定開始年月日               <chr> 
[2024/08/06 17:56:39] $ 西暦算定開始年月日           <date> 
[2024/08/06 17:56:39] $ 個別有効開始年月日           <chr> 
[2024/08/06 17:56:39] $ `備考（見出し）`             <chr> 
[2024/08/06 17:56:39] $ `備考（データ）`             <chr> 
[2024/08/06 17:56:39] $ 市町村コード                 <chr> 
[2024/08/06 17:56:39] $ 市町村名                     <chr> 
[2024/08/06 17:56:39] $ 種別コード                   <chr> 
[2024/08/06 17:56:39] $ 種別                         <chr> 
[2024/08/06 17:56:39] $ get_date                     <date> 
[2024/08/06 17:56:39] 
[2024/08/06 17:56:39] > df_all <- df_all %>% mutate(医療機関コード = str_glue("{都道府県コード}1{医療機関番号}"), 
[2024/08/06 17:56:39] +     .before = 都道府県コード) %>% print()
[2024/08/06 17:56:39] mutate: new variable '医療機関コード' (character) with 100,777 unique values and 0% NA
[2024/08/06 17:56:39] # A tibble: 991,755 × 27
[2024/08/06 17:56:39]    項番  医療機関コード 都道府県コード 都道府県名 区分  医療機関番号
[2024/08/06 17:56:39]    <chr> <glue>         <chr>          <chr>      <chr> <chr>       
[2024/08/06 17:56:39]  1 1     0810110056     08             茨城県     医科  0110056     
[2024/08/06 17:56:39]  2 1     0810110056     08             茨城県     医科  0110056     
[2024/08/06 17:56:39]  3 1     0810110056     08             茨城県     医科  0110056     
[2024/08/06 17:56:39]  4 1     0810110056     08             茨城県     医科  0110056     
[2024/08/06 17:56:39]  5 1     0810110056     08             茨城県     医科  0110056     
[2024/08/06 17:56:39]  6 1     0810110056     08             茨城県     医科  0110056     
[2024/08/06 17:56:39]  7 1     0810110056     08             茨城県     医科  0110056     
[2024/08/06 17:56:39]  8 1     0810110056     08             茨城県     医科  0110056     
[2024/08/06 17:56:39]  9 1     0810110056     08             茨城県     医科  0110056     
[2024/08/06 17:56:39] 10 1     0810110056     08             茨城県     医科  0110056     
[2024/08/06 17:56:39] # ℹ 991,745 more rows
[2024/08/06 17:56:39] # ℹ 21 more variables: 併設医療機関番号 <chr>, 医療機関記号番号 <chr>,
[2024/08/06 17:56:39] #   医療機関名称 <chr>, `医療機関所在地（郵便番号）` <chr>,
[2024/08/06 17:56:39] #   `医療機関所在地（住所）` <chr>, 電話番号 <chr>, FAX番号 <chr>,
[2024/08/06 17:56:39] #   病床数 <chr>, 受理届出名称 <chr>, 受理記号 <chr>, 受理番号 <chr>,
[2024/08/06 17:56:39] #   算定開始年月日 <chr>, 西暦算定開始年月日 <date>, 個別有効開始年月日 <chr>,
[2024/08/06 17:56:39] #   `備考（見出し）` <chr>, `備考（データ）` <chr>, 市町村コード <chr>, …
[2024/08/06 17:56:39] 
[2024/08/06 17:56:39] > pref_update_date <- df_all %>% group_by(都道府県コード, 
[2024/08/06 17:56:39] +     都道府県名) %>% summarise(update_date = max(西暦算定開始年月日, 
[2024/08/06 17:56:39] +     na.rm = T)) %>% ungroup() %>% print .... [TRUNCATED] 
[2024/08/06 17:56:39] group_by: 2 grouping variables (都道府県コード, 都道府県名)
[2024/08/06 17:56:39] summarise: now 47 rows and 3 columns, one group variable remaining (都道府県コード)
[2024/08/06 17:56:39] ungroup: no grouping variables
[2024/08/06 17:56:39] # A tibble: 47 × 3
[2024/08/06 17:56:39]    都道府県コード 都道府県名 update_date
[2024/08/06 17:56:39]    <chr>          <chr>      <date>     
[2024/08/06 17:56:39]  1 01             北海道     2024-07-01 
[2024/08/06 17:56:39]  2 02             青森県     2024-07-01 
[2024/08/06 17:56:39]  3 03             岩手県     2024-07-01 
[2024/08/06 17:56:39]  4 04             宮城県     2024-07-01 
[2024/08/06 17:56:39]  5 05             秋田県     2024-07-01 
[2024/08/06 17:56:39]  6 06             山形県     2024-07-01 
[2024/08/06 17:56:39]  7 07             福島県     2024-07-01 
[2024/08/06 17:56:39]  8 08             茨城県     2024-06-01 
[2024/08/06 17:56:39]  9 09             栃木県     2024-06-01 
[2024/08/06 17:56:39] 10 10             群馬県     2024-06-01 
[2024/08/06 17:56:39] # ℹ 37 more rows
[2024/08/06 17:56:39] 
[2024/08/06 17:56:39] > pref_update_date %>% writexl::write_xlsx(str_glue("{output_dir}/pref_update_date.xlsx"))
[2024/08/06 17:56:39] 
[2024/08/06 17:56:39] > df_all <- df_all %>% left_join(pref_update_date, by = c("都道府県コード", 
[2024/08/06 17:56:39] +     "都道府県名")) %>% glimpse()
[2024/08/06 17:56:39] left_join: added one column (update_date)
[2024/08/06 17:56:39]            > rows only in x         0
[2024/08/06 17:56:39]            > rows only in y  (      0)
[2024/08/06 17:56:49]            > matched rows     991,755
[2024/08/06 17:56:49]            >                 =========
[2024/08/06 17:56:49]            > rows total       991,755
[2024/08/06 17:56:49] Rows: 991,755
[2024/08/06 17:56:49] Columns: 28
[2024/08/06 17:56:49] $ 項番                         <chr> "1", "1", "1", "1", "1", "1", "1", "1", "…
[2024/08/06 17:56:49] $ 医療機関コード               <glue> "0810110056", "0810110056", "0810110056"…
[2024/08/06 17:56:49] $ 都道府県コード               <chr> "08", "08", "08", "08", "08", "08", "08",…
[2024/08/06 17:56:49] $ 都道府県名                   <chr> "茨城県", "茨城県", "茨城県", "茨城県", "…
[2024/08/06 17:56:49] $ 区分                         <chr> "医科", "医科", "医科", "医科", "医科", "…
[2024/08/06 17:56:49] $ 医療機関番号                 <chr> "0110056", "0110056", "0110056", "0110056…
[2024/08/06 17:56:49] $ 併設医療機関番号             <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:49] $ 医療機関記号番号             <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:49] $ 医療機関名称                 <chr> "水戸赤十字病院", "水戸赤十字病院", "水戸…
[2024/08/06 17:56:49] $ `医療機関所在地（郵便番号）` <chr> "310-0011", "310-0011", "310-0011", "310-…
[2024/08/06 17:56:49] $ `医療機関所在地（住所）`     <chr> "水戸市三の丸３－１２－４８", "水戸市三の…
[2024/08/06 17:56:49] $ 電話番号                     <chr> "029-221-5177", "029-221-5177", "029-221-…
[2024/08/06 17:56:49] $ FAX番号                      <chr> "029-227-0819", "029-227-0819", "029-227-…
[2024/08/06 17:56:49] $ 病床数                       <chr> "一般　　378／一般（感染）　感染　9", "一…
[2024/08/06 17:56:49] $ 受理届出名称                 <chr> "医療ＤＸ推進体制整備加算", "一般病棟入院…
[2024/08/06 17:56:49] $ 受理記号                     <chr> "医療ＤＸ", "一般入院", "救急医療", "超急…
[2024/08/06 17:56:49] $ 受理番号                     <chr> "第494号", "第134号", "第21号", "第2号", …
[2024/08/06 17:56:49] $ 算定開始年月日               <chr> "令和 6年 6月 1日", "令和 6年 6月 1日", "…
[2024/08/06 17:56:49] $ 西暦算定開始年月日           <date> 2024-06-01, 2024-06-01, 2020-04-01, 2008…
[2024/08/06 17:56:49] $ 個別有効開始年月日           <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:49] $ `備考（見出し）`             <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:49] $ `備考（データ）`             <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:49] $ 市町村コード                 <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:49] $ 市町村名                     <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:49] $ 種別コード                   <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:49] $ 種別                         <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:49] $ get_date                     <date> 2024-08-06, 2024-08-06, 2024-08-06, 2024…
[2024/08/06 17:56:49] $ update_date                  <date> 2024-06-01, 2024-06-01, 2024-06-01, 2024…
[2024/08/06 17:56:49] 
[2024/08/06 17:56:49] > df_all %>% saveRDS(str_glue("{output_dir}/df_all.rds"))
[2024/08/06 17:56:49] 
[2024/08/06 17:56:49] > df_all %>% glimpse()
[2024/08/06 17:56:49] Rows: 991,755
[2024/08/06 17:56:49] Columns: 28
[2024/08/06 17:56:49] $ 項番                         <chr> "1", "1", "1", "1", "1", "1", "1", "1", "…
[2024/08/06 17:56:49] $ 医療機関コード               <glue> "0810110056", "0810110056", "0810110056"…
[2024/08/06 17:56:49] $ 都道府県コード               <chr> "08", "08", "08", "08", "08", "08", "08",…
[2024/08/06 17:56:49] $ 都道府県名                   <chr> "茨城県", "茨城県", "茨城県", "茨城県", "…
[2024/08/06 17:56:49] $ 区分                         <chr> "医科", "医科", "医科", "医科", "医科", "…
[2024/08/06 17:56:49] $ 医療機関番号                 <chr> "0110056", "0110056", "0110056", "0110056…
[2024/08/06 17:56:49] $ 併設医療機関番号             <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:49] $ 医療機関記号番号             <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
[2024/08/06 17:56:49] $ 医療機関名称                 <chr> "水戸赤十字病院", "水戸赤十字病院", "水戸…
[2024/08/06 17:56:49] $ `医療機関所在地（郵便番号）` <chr> "310-0011", "310-0011", "310-0011", "310-…
[2024/08/06 17:56:49] $ `医療機関所在地（住所）`     <chr> "水戸市三の丸３－１２－４８", "水戸市三の…
[2024/08/06 17:56:49] $ 電話番号                     <chr> "029-221-5177", "029-221-5177", "029-221-…
[2024/08/06 17:56:49] $ FAX番号                      <chr> "029-227-0819", "029-227-0819", "029-227-…
